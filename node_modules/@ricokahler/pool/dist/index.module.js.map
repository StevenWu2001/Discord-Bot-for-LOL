{"version":3,"file":"index.module.js","sources":["../index.ts"],"sourcesContent":["interface Params<T, R> {\n  /**\n   * The input collection that will feed the tasks\n   */\n  collection: T[];\n  /**\n   * A function that takes an item from the collection and returns a result\n   */\n  task: (t: T, index: number) => Promise<R>;\n  /**\n   * The max number of concurrent tasks. If not provided, all tasks are ran at\n   * once\n   */\n  maxConcurrency?: number;\n}\n\n/**\n * Like `Promise.all` but you can specify how many concurrent tasks you want at once.\n */\nasync function pool<T, R>({\n  collection,\n  task,\n  maxConcurrency,\n}: Params<T, R>): Promise<R[]> {\n  if (!maxConcurrency) {\n    return Promise.all(collection.map((item, i) => task(item, i)));\n  }\n\n  if (!collection.length) {\n    return [];\n  }\n\n  const results: Array<[R, number]> = [];\n  const mutableCollection = collection\n    .slice()\n    .map((t, i) => [t, i] as [T, number]);\n\n  let available = maxConcurrency;\n  let done = false;\n  let globalResolve!: () => void;\n  let globalReject!: (err: Error) => void;\n  const finalPromise = new Promise<void>((resolve, reject) => {\n    globalResolve = resolve;\n    globalReject = reject;\n  });\n\n  const listeners = new Set<() => void>();\n  function notify() {\n    for (const listener of listeners) {\n      listener();\n    }\n  }\n  function ready() {\n    return new Promise<void>((resolve) => {\n      const listener = () => {\n        if (done) {\n          listeners.delete(listener);\n          resolve();\n        } else if (available > 0) {\n          listeners.delete(listener);\n          available -= 1;\n          resolve();\n        }\n      };\n\n      listeners.add(listener);\n      notify();\n    });\n  }\n\n  while (true) {\n    const value = mutableCollection.shift();\n    if (!value) break;\n    if (done) break;\n\n    const [t, i] = value;\n\n    await ready();\n\n    task(t, i)\n      .then((r) => {\n        results.push([r, i]);\n        available += 1;\n\n        if (results.length === collection.length) {\n          done = true;\n          globalResolve();\n        }\n      })\n      .catch((e) => {\n        done = true;\n        globalReject(e);\n      })\n      .finally(notify);\n  }\n\n  await finalPromise;\n\n  return results\n    .slice()\n    .sort(([, a], [, b]) => a - b)\n    .map(([r]) => r);\n}\n\nexport default pool;\n"],"names":["pool","collection","task","maxConcurrency","Promise","all","map","item","i","length","results","mutableCollection","slice","t","available","done","globalResolve","globalReject","finalPromise","resolve","reject","listeners","Set","notify","listener","ready","delete","add","value","shift","then","r","push","catch","e","finally","sort","a","b"],"mappings":"AAgBA;;;AAGA,eAAeA,IAAf,CAA0B;AACxBC,EAAAA,UADwB;AAExBC,EAAAA,IAFwB;AAGxBC,EAAAA;AAHwB,CAA1B;AAKE,MAAI,CAACA,cAAL,EAAqB;AACnB,WAAOC,OAAO,CAACC,GAAR,CAAYJ,UAAU,CAACK,GAAX,CAAe,CAACC,IAAD,EAAOC,CAAP,KAAaN,IAAI,CAACK,IAAD,EAAOC,CAAP,CAAhC,CAAZ,CAAP;AACD;;AAED,MAAI,CAACP,UAAU,CAACQ,MAAhB,EAAwB;AACtB,WAAO,EAAP;AACD;;AAED,QAAMC,OAAO,GAAuB,EAApC;AACA,QAAMC,iBAAiB,GAAGV,UAAU,CACjCW,KADuB,GAEvBN,GAFuB,CAEnB,CAACO,CAAD,EAAIL,CAAJ,KAAU,CAACK,CAAD,EAAIL,CAAJ,CAFS,CAA1B;AAIA,MAAIM,SAAS,GAAGX,cAAhB;AACA,MAAIY,IAAI,GAAG,KAAX;AACA,MAAIC,aAAJ;AACA,MAAIC,YAAJ;AACA,QAAMC,YAAY,GAAG,IAAId,OAAJ,CAAkB,CAACe,OAAD,EAAUC,MAAV;AACrCJ,IAAAA,aAAa,GAAGG,OAAhB;AACAF,IAAAA,YAAY,GAAGG,MAAf;AACD,GAHoB,CAArB;AAKA,QAAMC,SAAS,GAAG,IAAIC,GAAJ,EAAlB;;AACA,WAASC,MAAT;AACE,SAAK,MAAMC,QAAX,IAAuBH,SAAvB,EAAkC;AAChCG,MAAAA,QAAQ;AACT;AACF;;AACD,WAASC,KAAT;AACE,WAAO,IAAIrB,OAAJ,CAAmBe,OAAD;AACvB,YAAMK,QAAQ,GAAG;AACf,YAAIT,IAAJ,EAAU;AACRM,UAAAA,SAAS,CAACK,MAAV,CAAiBF,QAAjB;AACAL,UAAAA,OAAO;AACR,SAHD,MAGO,IAAIL,SAAS,GAAG,CAAhB,EAAmB;AACxBO,UAAAA,SAAS,CAACK,MAAV,CAAiBF,QAAjB;AACAV,UAAAA,SAAS,IAAI,CAAb;AACAK,UAAAA,OAAO;AACR;AACF,OATD;;AAWAE,MAAAA,SAAS,CAACM,GAAV,CAAcH,QAAd;AACAD,MAAAA,MAAM;AACP,KAdM,CAAP;AAeD;;AAED,SAAO,IAAP,EAAa;AACX,UAAMK,KAAK,GAAGjB,iBAAiB,CAACkB,KAAlB,EAAd;AACA,QAAI,CAACD,KAAL,EAAY;AACZ,QAAIb,IAAJ,EAAU;AAEV,UAAM,CAACF,CAAD,EAAIL,CAAJ,IAASoB,KAAf;AAEA,UAAMH,KAAK,EAAX;AAEAvB,IAAAA,IAAI,CAACW,CAAD,EAAIL,CAAJ,CAAJ,CACGsB,IADH,CACSC,CAAD;AACJrB,MAAAA,OAAO,CAACsB,IAAR,CAAa,CAACD,CAAD,EAAIvB,CAAJ,CAAb;AACAM,MAAAA,SAAS,IAAI,CAAb;;AAEA,UAAIJ,OAAO,CAACD,MAAR,KAAmBR,UAAU,CAACQ,MAAlC,EAA0C;AACxCM,QAAAA,IAAI,GAAG,IAAP;AACAC,QAAAA,aAAa;AACd;AACF,KATH,EAUGiB,KAVH,CAUUC,CAAD;AACLnB,MAAAA,IAAI,GAAG,IAAP;AACAE,MAAAA,YAAY,CAACiB,CAAD,CAAZ;AACD,KAbH,EAcGC,OAdH,CAcWZ,MAdX;AAeD;;AAED,QAAML,YAAN;AAEA,SAAOR,OAAO,CACXE,KADI,GAEJwB,IAFI,CAEC,CAAC,GAAGC,CAAH,CAAD,EAAQ,GAAGC,CAAH,CAAR,KAAkBD,CAAC,GAAGC,CAFvB,EAGJhC,GAHI,CAGA,CAAC,CAACyB,CAAD,CAAD,KAASA,CAHT,CAAP;AAID;;;;"}